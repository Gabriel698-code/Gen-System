<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gen System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>

    <style>
        :root {
            --bg-dark: #121214;
            --sidebar-dark: #202024;
            --input-bg: #202024;
            --text-primary: #e1e1e6;
            --text-secondary: #a8a8b3;
            --accent: #8257e5;
            --accent-hover: #996dff;
            --border: #323238;
            --user-msg: #8257e5;
            --ai-msg: #29292e;
        }

        * { box-sizing: border-box; }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: var(--bg-dark); color: var(--text-primary); display: flex; height: 100vh; overflow: hidden; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: #4d4d57; border-radius: 4px; }

        /* MODAIS */
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center; backdrop-filter: blur(4px); }
        .modal-box { width:90%; max-width:500px; padding:30px; background:var(--sidebar-dark); border-radius:12px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; }
        
        /* SIDEBAR */
        .sidebar { width: 280px; background-color: var(--sidebar-dark); display: flex; flex-direction: column; border-right: 1px solid var(--border); padding: 20px; }
        .logo { font-size: 1.5rem; font-weight: 800; color: white; display: flex; align-items: center; gap: 10px; margin-bottom: 30px; }
        .logo i { color: var(--accent); }
        
        .btn-main { width: 100%; padding: 12px; background-color: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; margin-bottom: 20px; }
        .btn-main:hover { background-color: var(--accent-hover); }

        .section-title { font-size: 0.75rem; color: var(--text-secondary); font-weight: 700; margin-bottom: 15px; letter-spacing: 1px; text-transform: uppercase; }
        .history-list { flex: 1; overflow-y: auto; margin-bottom: 20px; }
        
        .nav-item { padding: 10px 12px; margin-bottom: 5px; border-radius: 6px; cursor: pointer; color: var(--text-secondary); font-size: 0.9rem; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; text-decoration: none; }
        .nav-item:hover { background-color: var(--border); color: white; }
        
        /* Destaque para o botão de Dashboard */
        .nav-item.highlight { background: rgba(130, 87, 229, 0.1); border: 1px solid var(--accent); color: white; margin-bottom: 15px; }
        .nav-item.highlight:hover { background: rgba(130, 87, 229, 0.25); }
        .nav-item.highlight i { color: var(--accent); }

        .nav-content { display: flex; align-items: center; gap: 10px; overflow: hidden; flex: 1; }
        .nav-content i { width: 20px; text-align: center; }
        .nav-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }

        .btn-delete { opacity: 0; color: #ff6b6b; transition: 0.2s; padding: 6px; border-radius: 4px; }
        .nav-item:hover .btn-delete { opacity: 1; }
        .btn-delete:hover { background: rgba(255, 107, 107, 0.15); }

        .tools-section { border-top: 1px solid var(--border); padding-top: 20px; }

        /* MAIN */
        .main { flex: 1; display: flex; flex-direction: column; background: var(--bg-dark); position: relative; }
        .top-bar { padding: 15px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--sidebar-dark); }
        .modes { display: flex; gap: 10px; overflow-x: auto; }
        .mode-chip { padding: 6px 16px; border-radius: 20px; border: 1px solid var(--border); font-size: 0.85rem; cursor: pointer; color: var(--text-secondary); background: transparent; transition: 0.2s; white-space: nowrap; }
        .mode-chip:hover { border-color: var(--accent); color: white; }
        .mode-chip.active { background: rgba(130, 87, 229, 0.15); color: var(--accent); border-color: var(--accent); font-weight: 600; }

        .chat-container { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        
        .message { max-width: 85%; padding: 15px 25px; border-radius: 12px; line-height: 1.6; font-size: 0.95rem; position: relative; word-wrap: break-word; }
        .message.user { align-self: flex-end; background-color: var(--user-msg); color: white; border-bottom-right-radius: 4px; }
        .message.model { align-self: flex-start; background-color: var(--ai-msg); color: var(--text-primary); border-bottom-left-radius: 4px; border: 1px solid var(--border); }
        
        .message p { margin-bottom: 10px; margin-top: 0; }
        .message strong { color: white; font-weight: 700; text-shadow: 0 0 1px rgba(0,0,0,0.5); }
        .message ul, .message ol { margin: 10px 0; padding-left: 20px; }
        .message li { margin-bottom: 5px; }
        .message h3 { margin-top: 15px; margin-bottom: 10px; color: white; font-weight: bold; font-size: 1.1em; }
        .message a { color: #a277ff; }

        .input-area { padding: 20px; background: var(--sidebar-dark); border-top: 1px solid var(--border); }
        .file-preview { display: none; padding: 8px 12px; margin-bottom: 10px; background: #29292e; border-radius: 6px; font-size: 0.85rem; color: var(--text-primary); align-items: center; width: fit-content; gap: 10px; border: 1px solid var(--border); }
        .input-wrapper { display: flex; align-items: center; gap: 12px; background: var(--input-bg); padding: 10px 15px; border-radius: 12px; border: 1px solid var(--border); transition: 0.2s; }
        .input-wrapper:focus-within { border-color: var(--accent); }
        input[type="text"] { flex: 1; background: transparent; border: none; outline: none; font-size: 1rem; color: white; }
        
        .btn-icon { color: var(--text-secondary); cursor: pointer; background: none; border: none; font-size: 1.1rem; transition: 0.2s; padding: 5px; }
        .btn-icon:hover { color: white; }
        .btn-send { color: var(--accent); }
        
        .setup-input { width: 100%; padding: 12px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; color: white; margin: 15px 0; outline: none; }
        .setup-input:focus { border-color: var(--accent); }
    </style>
</head>
<body>

    <div id="setup-modal" class="modal-overlay">
        <div class="modal-box" style="text-align: center;">
            <i class="fas fa-fingerprint" style="font-size:48px; color:var(--accent); margin-bottom:20px;"></i>
            <h2 style="margin:0 0 10px 0; color:white;">Ativação Necessária</h2>
            <p style="color:var(--text-secondary); font-size:14px; margin-bottom:20px;">
                O Gen System roda localmente.<br>Insira sua chave gratuita do Google para ativar.
            </p>
            <input type="password" id="input-key" class="setup-input" placeholder="Cole sua API Key aqui (AIza...)">
            <button onclick="ativarSistema()" id="btn-ativar" class="btn-main">ATIVAR SISTEMA</button>
            <p style="margin-top:20px; font-size:13px; color:#555;">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--accent);">Gerar Chave Grátis ↗</a>
            </p>
        </div>
    </div>

    <div class="sidebar">
        <div class="logo"><i class="fas fa-robot"></i> GEN SYSTEM</div>
        <button class="btn-main" onclick="novoChat()"><i class="fas fa-plus"></i> Novo Chat</button>
        <div class="section-title">Histórico</div>
        <div class="history-list" id="history-list"></div>
        <div class="tools-section">
            
            <a href="http://127.0.0.1:8501" target="_blank" class="nav-item highlight">
                <div class="nav-content">
                    <i class="fas fa-folder-open"></i> 
                    <span class="nav-text" style="font-weight: 700;">Gerenciamento de Arquivos</span>
                </div>
            </a>

            <div class="section-title" style="margin-top: 15px;">Geradores</div>
            <a href="orcamento.html" target="_blank" class="nav-item"><div class="nav-content"><i class="fas fa-file-invoice-dollar"></i> <span class="nav-text">Orçamento</span></div></a>
            <a href="recibo.html" target="_blank" class="nav-item"><div class="nav-content"><i class="fas fa-receipt"></i> <span class="nav-text">Recibo</span></div></a>
            <a href="contrato.html" target="_blank" class="nav-item"><div class="nav-content"><i class="fas fa-file-signature"></i> <span class="nav-text">Contrato</span></div></a>
            <a href="os.html" target="_blank" class="nav-item"><div class="nav-content"><i class="fas fa-tools"></i> <span class="nav-text">Ordem de Serviço</span></div></a>
            <a href="nfe_simples.html" target="_blank" class="nav-item"><div class="nav-content"><i class="fas fa-barcode"></i> <span class="nav-text">NFe Simples</span></div></a>
        </div>
    </div>

    <div class="main">
        <div class="top-bar">
            <div class="modes">
                <div class="mode-chip active" onclick="setMode('geral', this)"><i class="fas fa-lightbulb"></i> Geral</div>
                <div class="mode-chip" onclick="setMode('juridico', this)"><i class="fas fa-balance-scale"></i> Jurídico</div>
                <div class="mode-chip" onclick="setMode('financeiro', this)"><i class="fas fa-chart-line"></i> Finanças</div>
                <div class="mode-chip" onclick="setMode('marketing', this)"><i class="fas fa-bullhorn"></i> Mkt</div>
                <div class="mode-chip" onclick="setMode('viabilidade', this)"><i class="fas fa-search-location"></i> Viabilidade</div>
            </div>
        </div>

        <div class="chat-container" id="chat-box">
            <div style="text-align:center; margin-top:80px; color:var(--text-secondary);">
                <i class="fas fa-brain" style="font-size:64px; margin-bottom:20px; opacity:0.3;"></i>
                <h2>Como posso ajudar?</h2>
            </div>
        </div>

        <div class="input-area">
            <div class="file-preview" id="file-area">
                <span id="file-name">arquivo.pdf</span>
                <i class="fas fa-times" style="cursor:pointer; color: #ff6b6b;" onclick="limparArquivo()"></i>
            </div>
            <div class="input-wrapper">
                <input type="file" id="file-input" style="display: none;" onchange="arquivoSelecionado()">
                <button class="btn-icon" onclick="document.getElementById('file-input').click()"><i class="fas fa-paperclip"></i></button>
                <input type="text" id="user-input" placeholder="Digite sua mensagem..." onkeypress="handleEnter(event)">
                <button class="btn-icon btn-send" onclick="enviarMensagem()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script>
        // --- PERSISTÊNCIA DE SESSÃO ---
        let sessionId = localStorage.getItem("gen_session_id");
        if (!sessionId) {
            sessionId = "sessao_" + Date.now();
            localStorage.setItem("gen_session_id", sessionId);
        }
        
        let currentMode = "geral";
        let fileToSend = null;

        function formatarTexto(text) {
            if (typeof marked !== 'undefined') {
                try { return marked.parse(text, { breaks: true }); } 
                catch(e) { console.log("Erro no marked:", e); }
            }
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        }

        async function verificarAtivacao() {
            try {
                const res = await fetch('http://127.0.0.1:8000/verificar_status');
                const dados = await res.json();
                if (dados.status === 'pendente') document.getElementById('setup-modal').style.display = 'flex';
            } catch(e) {}
        }

        async function ativarSistema() {
            const key = document.getElementById('input-key').value.trim();
            const btn = document.getElementById('btn-ativar');
            if (!key) return alert("Insira a chave.");
            btn.innerHTML = 'Validando...'; btn.disabled = true;
            try {
                const res = await fetch('http://127.0.0.1:8000/salvar_chave', {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({api_key: key})
                });
                const r = await res.json();
                if (r.status === 'ok') {
                    document.getElementById('setup-modal').style.display = 'none';
                    alert("Ativado!");
                } else { alert("Erro: " + r.mensagem); btn.disabled = false; }
            } catch(e) { btn.disabled = false; }
        }

        function setMode(mode, el) {
            currentMode = mode;
            document.querySelectorAll('.mode-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            appendMessage('model', `Modo: **${mode.toUpperCase()}**. O que deseja?`);
        }

        function appendMessage(role, text) {
            const box = document.getElementById('chat-box');
            if(box.querySelector('h2')) box.innerHTML = "";
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = role === 'model' ? formatarTexto(text) : text.replace(/\n/g, '<br>');
            box.appendChild(div); box.scrollTop = box.scrollHeight;
        }

        function arquivoSelecionado() {
            const input = document.getElementById('file-input');
            if (input.files.length > 0) {
                fileToSend = input.files[0];
                document.getElementById('file-name').innerText = fileToSend.name;
                document.getElementById('file-area').style.display = 'flex';
            }
        }
        function limparArquivo() {
            fileToSend = null;
            document.getElementById('file-input').value = "";
            document.getElementById('file-area').style.display = 'none';
        }

        async function enviarMensagem() {
            const input = document.getElementById('user-input');
            const texto = input.value.trim();
            if (!texto && !fileToSend) return;

            appendMessage('user', texto + (fileToSend ? ` <br><small>[Anexo: ${fileToSend.name}]</small>` : ""));
            input.value = "";
            
            const load = document.createElement('div'); load.className = 'message model'; load.id = 'loading';
            load.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
            document.getElementById('chat-box').appendChild(load);

            try {
                let res;
                if (fileToSend) {
                    const fd = new FormData();
                    fd.append('session_id', sessionId);
                    fd.append('texto', texto || "Analise");
                    fd.append('arquivo', fileToSend);
                    res = await fetch('http://127.0.0.1:8000/chat_com_imagem', { method: 'POST', body: fd });
                    limparArquivo();
                } else {
                    res = await fetch('http://127.0.0.1:8000/chat', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ session_id: sessionId, texto: texto, modo: currentMode })
                    });
                }
                const data = await res.json();
                document.getElementById('loading').remove();
                appendMessage('model', data.resposta_gen || data.resposta_usuario || "Erro.");
                carregarHistorico();
            } catch(e) {
                document.getElementById('loading').remove();
                appendMessage('model', "Erro de conexão.");
            }
        }

        async function carregarHistorico() {
            try {
                const res = await fetch('http://127.0.0.1:8000/sessions');
                const sessions = await res.json();
                const list = document.getElementById('history-list');
                list.innerHTML = "";
                sessions.forEach(s => {
                    const div = document.createElement('div'); div.className = 'nav-item';
                    div.innerHTML = `<div class="nav-content" onclick="carregarChat('${s.id}')"><i class="far fa-comment"></i> <span class="nav-text">${s.titulo || "Conversa"}</span></div><i class="fas fa-trash btn-delete" onclick="delChat('${s.id}', event)"></i>`;
                    list.appendChild(div);
                });
            } catch(e) {}
        }

        async function delChat(id, e) {
            e.stopPropagation();
            if(!confirm("Apagar?")) return;
            await fetch(`http://127.0.0.1:8000/chat/${id}`, { method: 'DELETE' });
            if(sessionId === id) novoChat();
            carregarHistorico();
        }

        async function carregarChat(id) {
            sessionId = id;
            localStorage.setItem("gen_session_id", id);
            const res = await fetch(`http://127.0.0.1:8000/historico/${id}`);
            const msgs = await res.json();
            document.getElementById('chat-box').innerHTML = "";
            msgs.forEach(m => appendMessage(m.role, m.content));
        }

        function novoChat() {
            sessionId = "sessao_" + Date.now();
            localStorage.setItem("gen_session_id", sessionId);
            document.getElementById('chat-box').innerHTML = `<div style="text-align:center; margin-top:80px; color:#a8a8b3;"><h2>Novo Chat</h2></div>`;
        }

        function handleEnter(e) { if(e.key === 'Enter') enviarMensagem(); }

        verificarAtivacao();
        carregarHistorico();
    </script>
</body>
</html>